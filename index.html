<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuizSENA · Generador (1 archivo)</title>

  <!-- UI (el generador) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" referrerpolicy="no-referrer" />

  <!-- Excel parser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* Ajustes finos del generador (no depende de Tailwind) */
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,.78); }
    .mono { font-variant-numeric: tabular-nums; }
  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="sticky top-0 z-20 border-b border-slate-200 bg-white/80 glass">
    <div class="mx-auto max-w-6xl px-4 py-4 flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-[#39A900] flex items-center justify-center shadow">
        <i class="fa-solid fa-check-to-slot text-white"></i>
      </div>
      <div class="flex-1">
        <div class="flex flex-wrap items-center gap-x-3 gap-y-1">
          <h1 class="text-lg sm:text-xl font-extrabold tracking-tight">QuizSENA</h1>
          <span class="text-[11px] font-bold uppercase tracking-widest text-slate-400">Generador • 1 archivo HTML</span>
        </div>
        <p class="text-xs text-slate-500">Convierte un banco en Excel (.xlsx) en un examen HTML auto‑contenido (offline).</p>
      </div>
      <button id="btnReset" class="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-bold">
        <i class="fa-solid fa-rotate"></i> Reset
      </button>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-8">
    <!-- Top cards -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Upload -->
      <div class="lg:col-span-2 rounded-3xl border border-slate-200 bg-white shadow-sm p-6">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-base font-extrabold tracking-tight flex items-center gap-2">
              <i class="fa-solid fa-file-excel text-[#39A900]"></i> Banco de preguntas (Excel)
            </h2>
            <p class="text-xs text-slate-500 mt-1">
              Formato recomendado: Col A = Pregunta, Col B = Correctas (separadas por “;”), Col C… = Incorrectas.
            </p>
          </div>
          <div class="text-right">
            <div class="text-[11px] font-extrabold uppercase tracking-widest text-slate-400">Estado</div>
            <div class="flex items-center justify-end gap-2 mt-1">
              <span id="dotState" class="w-2.5 h-2.5 rounded-full bg-slate-300"></span>
              <span id="txtState" class="text-sm font-extrabold">Sin archivo</span>
            </div>
          </div>
        </div>

        <!-- Dropzone -->
        <div id="dropzone" class="mt-5 rounded-3xl border-2 border-dashed border-slate-200 bg-slate-50 hover:bg-slate-100/60 transition p-6 cursor-pointer">
          <div class="flex flex-col sm:flex-row items-center gap-4">
            <div class="w-14 h-14 rounded-2xl bg-white border border-slate-200 flex items-center justify-center shadow-sm">
              <i id="dzIcon" class="fa-solid fa-cloud-arrow-up text-2xl text-slate-400"></i>
            </div>
            <div class="flex-1 text-center sm:text-left">
              <div class="font-extrabold">Arrastra y suelta tu .xlsx aquí</div>
              <div class="text-xs text-slate-500 mt-1">o haz clic para seleccionar un archivo.</div>
              <div id="fileMeta" class="text-xs text-slate-600 mt-2 hidden">
                <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-white border border-slate-200">
                  <i class="fa-solid fa-file-lines text-slate-500"></i>
                  <span id="fileName" class="font-bold"></span>
                </span>
              </div>
            </div>
            <div class="w-full sm:w-auto">
              <label class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl bg-[#39A900] hover:bg-[#2d8500] text-white font-extrabold shadow-sm cursor-pointer">
                <i class="fa-solid fa-folder-open"></i> Seleccionar
                <input id="fileInput" type="file" accept=".xlsx" class="hidden" />
              </label>
            </div>
          </div>

          <div id="progressRow" class="mt-5 hidden">
            <div class="h-2 rounded-full bg-slate-200 overflow-hidden">
              <div id="progressBar" class="h-2 bg-[#39A900] w-0 transition-all"></div>
            </div>
            <div id="progressTxt" class="text-xs text-slate-500 mt-2">Procesando…</div>
          </div>
        </div>

        <!-- Sheet + summary -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="md:col-span-1">
            <label class="block text-[11px] font-extrabold uppercase tracking-widest text-slate-400 mb-2">Hoja</label>
            <select id="sheetSelect" class="w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white font-bold text-sm focus:outline-none focus:ring-2 focus:ring-[#39A900]/30 focus:border-[#39A900]" disabled>
              <option value="">—</option>
            </select>
            <p class="text-[11px] text-slate-500 mt-2">Se cargará la primera hoja por defecto.</p>
          </div>
          <div class="md:col-span-2 rounded-3xl border border-slate-200 bg-slate-50 p-4">
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
              <div class="rounded-2xl bg-white border border-slate-200 p-3">
                <div class="text-[11px] font-extrabold uppercase tracking-widest text-slate-400">Total</div>
                <div id="statTotal" class="text-xl font-extrabold mono mt-1">0</div>
              </div>
              <div class="rounded-2xl bg-white border border-slate-200 p-3">
                <div class="text-[11px] font-extrabold uppercase tracking-widest text-slate-400">Válidas</div>
                <div id="statValid" class="text-xl font-extrabold mono mt-1">0</div>
              </div>
              <div class="rounded-2xl bg-white border border-slate-200 p-3">
                <div class="text-[11px] font-extrabold uppercase tracking-widest text-slate-400">Con alertas</div>
                <div id="statWarn" class="text-xl font-extrabold mono mt-1">0</div>
              </div>
              <div class="rounded-2xl bg-white border border-slate-200 p-3">
                <div class="text-[11px] font-extrabold uppercase tracking-widest text-slate-400">Opc. promedio</div>
                <div id="statOpts" class="text-xl font-extrabold mono mt-1">0</div>
              </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
              <button id="btnShowIssues" class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-extrabold" disabled>
                <i class="fa-solid fa-triangle-exclamation text-amber-600"></i> Ver validación
              </button>
              <button id="btnClearFile" class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-extrabold" disabled>
                <i class="fa-solid fa-xmark"></i> Quitar archivo
              </button>
            </div>
          </div>
        </div>

        <!-- Preview -->
        <div class="mt-6 rounded-3xl border border-slate-200 bg-white p-5">
          <div class="flex items-center justify-between gap-4">
            <h3 class="text-sm font-extrabold uppercase tracking-widest text-slate-400">Vista previa</h3>
            <div class="text-xs text-slate-500">Se muestra la primera pregunta válida.</div>
          </div>
          <div id="previewBox" class="mt-4 rounded-2xl bg-slate-950 text-white p-5">
            <div class="text-xs font-extrabold text-[#39A900] uppercase tracking-widest">Ejemplo</div>
            <div id="previewQ" class="mt-2 text-base font-bold leading-snug">—</div>
            <div id="previewOpts" class="mt-4 space-y-2"></div>
          </div>
        </div>
      </div>

      <!-- Config -->
      <div class="rounded-3xl border border-slate-200 bg-white shadow-sm p-6">
        <h2 class="text-base font-extrabold tracking-tight flex items-center gap-2">
          <i class="fa-solid fa-sliders text-[#39A900]"></i> Configuración
        </h2>
        <p class="text-xs text-slate-500 mt-1">Estos parámetros se guardan localmente en tu navegador.</p>

        <div class="mt-5 space-y-4">
          <div>
            <label class="block text-[11px] font-extrabold uppercase tracking-widest text-slate-400 mb-2">Título</label>
            <input id="cfgTitle" type="text" class="w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white font-bold text-sm focus:outline-none focus:ring-2 focus:ring-[#39A900]/30 focus:border-[#39A900]" />
          </div>

          <div>
            <label class="block text-[11px] font-extrabold uppercase tracking-widest text-slate-400 mb-2">Instructor</label>
            <input id="cfgInstructor" type="text" placeholder="Ej: JUAN PEREZ" class="w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white font-bold text-sm focus:outline-none focus:ring-2 focus:ring-[#39A900]/30 focus:border-[#39A900]" />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-[11px] font-extrabold uppercase tracking-widest text-slate-400 mb-2">N° preguntas</label>
              <input id="cfgCount" type="number" min="1" class="w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white font-bold text-sm focus:outline-none focus:ring-2 focus:ring-[#39A900]/30 focus:border-[#39A900]" />
              <div class="text-[11px] text-slate-500 mt-2">Máx: <span id="maxCount" class="font-extrabold mono">0</span></div>
            </div>
            <div>
              <label class="block text-[11px] font-extrabold uppercase tracking-widest text-slate-400 mb-2">Opciones visibles</label>
              <select id="cfgOptions" class="w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white font-bold text-sm focus:outline-none focus:ring-2 focus:ring-[#39A900]/30 focus:border-[#39A900]">
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
              </select>
              <div class="text-[11px] text-slate-500 mt-2">Incluye correctas + incorrectas.</div>
            </div>
          </div>

          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 space-y-3">
            <div class="flex items-start gap-3">
              <input id="cfgTimer" type="checkbox" class="mt-1 w-5 h-5 accent-[#39A900]" />
              <div class="flex-1">
                <div class="font-extrabold text-sm">Temporizador global</div>
                <div class="text-xs text-slate-500">Cuenta regresiva para todo el examen.</div>
                <div id="timerRow" class="mt-2 hidden items-center gap-2">
                  <input id="cfgTimeLimit" type="number" min="1" class="w-24 px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold text-sm focus:outline-none focus:ring-2 focus:ring-[#39A900]/30 focus:border-[#39A900]" />
                  <span class="text-xs text-slate-500 font-bold">minutos</span>
                </div>
              </div>
            </div>

            <div class="flex items-start gap-3">
              <input id="cfgSequential" type="checkbox" class="mt-1 w-5 h-5 accent-[#39A900]" />
              <div class="flex-1">
                <div class="font-extrabold text-sm">Modo secuencial</div>
                <div class="text-xs text-slate-500">Muestra 1 pregunta a la vez (sin retroceder).</div>
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <label class="flex items-center gap-3 rounded-2xl border border-slate-200 bg-white p-3 cursor-pointer select-none">
                <input id="cfgShuffleQ" type="checkbox" class="w-5 h-5 accent-[#39A900]" />
                <span class="text-sm font-extrabold">Barajar preguntas</span>
              </label>
              <label class="flex items-center gap-3 rounded-2xl border border-slate-200 bg-white p-3 cursor-pointer select-none">
                <input id="cfgShuffleO" type="checkbox" class="w-5 h-5 accent-[#39A900]" />
                <span class="text-sm font-extrabold">Barajar opciones</span>
              </label>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 pt-1">
            <button id="btnPreview" class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 font-extrabold" disabled>
              <i class="fa-solid fa-eye"></i> Previsualizar
            </button>
            <button id="btnGenerate" class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl bg-[#39A900] hover:bg-[#2d8500] text-white font-extrabold shadow-sm disabled:opacity-40 disabled:cursor-not-allowed" disabled>
              <i class="fa-solid fa-wand-magic-sparkles"></i> Generar HTML
            </button>
          </div>

          <div class="text-[11px] text-slate-500 leading-relaxed">
            El HTML generado no requiere internet: trae estilos y lógica embebidos.
          </div>
        </div>
      </div>
    </section>

    <!-- Modal: issues -->
    <dialog id="issuesDialog" class="w-[min(900px,95vw)] rounded-3xl border border-slate-200 p-0 shadow-2xl">
      <div class="p-5 border-b border-slate-200 bg-white">
        <div class="flex items-center justify-between gap-4">
          <div>
            <div class="text-sm font-extrabold tracking-tight">Validación del banco</div>
            <div class="text-xs text-slate-500 mt-1">Filas con problemas comunes y recomendaciones.</div>
          </div>
          <button id="btnCloseIssues" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-extrabold">
            <i class="fa-solid fa-xmark"></i> Cerrar
          </button>
        </div>
      </div>
      <div class="p-5 bg-slate-50">
        <div class="rounded-2xl border border-slate-200 bg-white overflow-hidden">
          <div class="max-h-[55vh] overflow-auto">
            <table class="w-full text-sm">
              <thead class="sticky top-0 bg-white border-b border-slate-200">
                <tr>
                  <th class="text-left p-3 text-[11px] font-extrabold uppercase tracking-widest text-slate-400 w-20">Fila</th>
                  <th class="text-left p-3 text-[11px] font-extrabold uppercase tracking-widest text-slate-400">Detalle</th>
                  <th class="text-left p-3 text-[11px] font-extrabold uppercase tracking-widest text-slate-400 w-32">Tipo</th>
                </tr>
              </thead>
              <tbody id="issuesTbody" class="[&>tr:nth-child(even)]:bg-slate-50"></tbody>
            </table>
          </div>
        </div>
        <div class="mt-4 text-xs text-slate-600">
          Reglas: (1) Pregunta y correctas son obligatorias. (2) Debe haber al menos 1 opción incorrecta. (3) Correctas pueden ser múltiples separadas por “;”.
        </div>
      </div>
    </dialog>

    <!-- Footer -->
    <footer class="mt-10 text-center text-slate-400">
      <p class="text-[11px] font-extrabold uppercase tracking-[0.25em]">Servicio Nacional de Aprendizaje • SENA</p>
    </footer>
  </main>

  <script>
    "use strict";

    /** ============================
     *  Estado y utilidades
     *  ============================ */
    const STORAGE_KEY = "quizsena_generator_v1";

    const state = {
      file: null,
      fileName: null,
      workbook: null,
      sheetName: null,
      rawRows: [],
      questions: [],     // { pregunta, correctas[], incorrectas[] }
      issues: [],        // { rowIndex, type, detail }
      config: {
        title: "Evaluación de Aprendizaje SENA",
        instructor: "",
        count: 10,
        optionsCount: 4,
        hasTimer: false,
        timeLimit: 30,
        sequentialMode: true,
        shuffleQuestions: true,
        shuffleOptions: true
      }
    };

    const $ = (id) => document.getElementById(id);

    function clampInt(n, min, max, fallback) {
      const x = parseInt(String(n), 10);
      if (Number.isNaN(x)) return fallback;
      return Math.max(min, Math.min(max, x));
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function slugify(str) {
      return String(str || "")
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-zA-Z0-9]+/g, "_")
        .replace(/^_+|_+$/g, "")
        .slice(0, 80) || "QuizSENA";
    }

    function shuffleInPlace(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function sample(arr, k) {
      const copy = arr.slice();
      shuffleInPlace(copy);
      return copy.slice(0, k);
    }

    function uniqNonEmpty(list) {
      const seen = new Set();
      const out = [];
      for (const v of list) {
        const s = String(v ?? "").trim();
        if (!s) continue;
        const key = s.toLowerCase();
        if (seen.has(key)) continue;
        seen.add(key);
        out.push(s);
      }
      return out;
    }

    function loadConfig() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object" && parsed.config) {
          state.config = { ...state.config, ...parsed.config };
        }
      } catch (_) { /* ignore */ }
    }

    function saveConfig() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ config: state.config }));
      } catch (_) { /* ignore */ }
    }

    /** ============================
     *  DOM: sincronización
     *  ============================ */
    const dom = {
      btnReset: $("btnReset"),
      fileInput: $("fileInput"),
      dropzone: $("dropzone"),
      dzIcon: $("dzIcon"),
      fileMeta: $("fileMeta"),
      fileName: $("fileName"),
      sheetSelect: $("sheetSelect"),
      dotState: $("dotState"),
      txtState: $("txtState"),
      progressRow: $("progressRow"),
      progressBar: $("progressBar"),
      progressTxt: $("progressTxt"),
      statTotal: $("statTotal"),
      statValid: $("statValid"),
      statWarn: $("statWarn"),
      statOpts: $("statOpts"),
      maxCount: $("maxCount"),
      btnShowIssues: $("btnShowIssues"),
      btnClearFile: $("btnClearFile"),
      previewQ: $("previewQ"),
      previewOpts: $("previewOpts"),
      cfgTitle: $("cfgTitle"),
      cfgInstructor: $("cfgInstructor"),
      cfgCount: $("cfgCount"),
      cfgOptions: $("cfgOptions"),
      cfgTimer: $("cfgTimer"),
      cfgTimeLimit: $("cfgTimeLimit"),
      timerRow: $("timerRow"),
      cfgSequential: $("cfgSequential"),
      cfgShuffleQ: $("cfgShuffleQ"),
      cfgShuffleO: $("cfgShuffleO"),
      btnPreview: $("btnPreview"),
      btnGenerate: $("btnGenerate"),
      issuesDialog: $("issuesDialog"),
      issuesTbody: $("issuesTbody"),
      btnCloseIssues: $("btnCloseIssues")
    };

    function setLoading(isLoading, msg) {
      dom.progressRow.classList.toggle("hidden", !isLoading);
      dom.progressBar.style.width = isLoading ? "60%" : "0%";
      dom.progressTxt.textContent = msg || "Procesando…";
      dom.dropzone.classList.toggle("opacity-70", isLoading);
      dom.dropzone.classList.toggle("pointer-events-none", isLoading);
    }

    function setStateBadge(ok, label) {
      dom.dotState.className = "w-2.5 h-2.5 rounded-full " + (ok ? "bg-[#39A900] shadow-[0_0_8px_rgba(57,169,0,.6)]" : "bg-slate-300");
      dom.txtState.textContent = label;
    }

    function renderStats() {
      const total = state.questions.length;
      const valid = total; // ya filtradas
      const warn = state.issues.length;

      const avgOpts = total === 0 ? 0 : Math.round(
        state.questions.reduce((acc, q) => acc + (q.correctas.length + q.incorrectas.length), 0) / total
      );

      dom.statTotal.textContent = String(state.rawRows.length);
      dom.statValid.textContent = String(valid);
      dom.statWarn.textContent = String(warn);
      dom.statOpts.textContent = String(avgOpts);
      dom.maxCount.textContent = String(valid);

      // Ajustar cfgCount
      const maxCount = Math.max(1, valid);
      state.config.count = clampInt(state.config.count, 1, maxCount, Math.min(10, maxCount));
      dom.cfgCount.value = String(state.config.count);

      dom.btnShowIssues.disabled = warn === 0;
      dom.btnClearFile.disabled = !state.file;
      dom.btnGenerate.disabled = valid === 0;
      dom.btnPreview.disabled = valid === 0;

      dom.cfgCount.max = String(maxCount);
    }

    function renderPreview() {
      const q = state.questions[0];
      if (!q) {
        dom.previewQ.textContent = "—";
        dom.previewOpts.innerHTML = "";
        return;
      }
      dom.previewQ.textContent = q.pregunta;

      // Mostrar 1 correcta + N incorrectas (solo vista previa)
      const opts = [];
      if (q.correctas[0]) opts.push({ text: q.correctas[0], isCorrect: true });
      const neededIncorrect = Math.max(1, state.config.optionsCount - 1);
      for (const inc of q.incorrectas.slice(0, neededIncorrect)) {
        opts.push({ text: inc, isCorrect: false });
      }

      dom.previewOpts.innerHTML = opts.map(o => `
        <div class="bg-white/10 px-4 py-2 rounded-xl text-xs sm:text-[13px] font-bold border border-white/5 flex items-center gap-2">
          <div class="w-3 h-3 rounded border border-white/20 ${o.isCorrect ? "bg-[#39A900]/60 border-[#39A900]" : ""}"></div>
          <span>${escapeHtml(o.text)}</span>
        </div>
      `).join("");
    }

    function syncConfigToDom() {
      dom.cfgTitle.value = state.config.title;
      dom.cfgInstructor.value = state.config.instructor;
      dom.cfgCount.value = String(state.config.count);
      dom.cfgOptions.value = String(state.config.optionsCount);
      dom.cfgTimer.checked = !!state.config.hasTimer;
      dom.cfgTimeLimit.value = String(state.config.timeLimit);
      dom.timerRow.classList.toggle("hidden", !state.config.hasTimer);
      dom.timerRow.classList.toggle("flex", !!state.config.hasTimer);
      dom.cfgSequential.checked = !!state.config.sequentialMode;
      dom.cfgShuffleQ.checked = !!state.config.shuffleQuestions;
      dom.cfgShuffleO.checked = !!state.config.shuffleOptions;
    }

    function readConfigFromDom() {
      state.config.title = dom.cfgTitle.value.trim() || "Evaluación de Aprendizaje SENA";
      state.config.instructor = dom.cfgInstructor.value.trim();
      const maxCount = Math.max(1, state.questions.length || 1);
      state.config.count = clampInt(dom.cfgCount.value, 1, maxCount, Math.min(10, maxCount));
      state.config.optionsCount = clampInt(dom.cfgOptions.value, 2, 10, 4);
      state.config.hasTimer = !!dom.cfgTimer.checked;
      state.config.timeLimit = clampInt(dom.cfgTimeLimit.value, 1, 999, 30);
      state.config.sequentialMode = !!dom.cfgSequential.checked;
      state.config.shuffleQuestions = !!dom.cfgShuffleQ.checked;
      state.config.shuffleOptions = !!dom.cfgShuffleO.checked;
      saveConfig();
      renderPreview();
    }

    /** ============================
     *  Excel -> preguntas
     *  ============================ */
    function parseSheetToQuestions(ws) {
      const all = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false });
      state.rawRows = Array.isArray(all) ? all.slice(1) : [];
      state.issues = [];

      const questions = [];
      state.rawRows.forEach((row, idx) => {
        const rowNum = idx + 2; // + header row

        const qText = String((row && row[0]) ?? "").trim();
        const correctCell = String((row && row[1]) ?? "").trim();

        const incorrectCells = (row || []).slice(2).map(v => String(v ?? "").trim()).filter(Boolean);

        if (!qText && !correctCell && incorrectCells.length === 0) return; // fila vacía

        if (!qText) {
          state.issues.push({ rowIndex: rowNum, type: "ERROR", detail: "Falta la pregunta (Col A)." });
          return;
        }
        if (!correctCell) {
          state.issues.push({ rowIndex: rowNum, type: "ERROR", detail: "Faltan respuestas correctas (Col B)." });
          return;
        }

        const correctas = uniqNonEmpty(correctCell.split(";").map(s => s.trim()));
        const incorrectas = uniqNonEmpty(incorrectCells);

        if (correctas.length === 0) {
          state.issues.push({ rowIndex: rowNum, type: "ERROR", detail: "No se detectaron correctas válidas en Col B." });
          return;
        }
        if (incorrectas.length === 0) {
          state.issues.push({ rowIndex: rowNum, type: "ERROR", detail: "No se detectaron incorrectas (Col C en adelante)." });
          return;
        }

        // Alertas (no bloqueantes)
        const totalOpts = correctas.length + incorrectas.length;
        if (totalOpts < 3) {
          state.issues.push({ rowIndex: rowNum, type: "WARN", detail: "Muy pocas opciones (recomendado: 4 o más)." });
        }
        if (correctas.length > 1) {
          state.issues.push({ rowIndex: rowNum, type: "INFO", detail: "Pregunta con múltiples correctas (se evaluará selección múltiple)." });
        }

        questions.push({ pregunta: qText, correctas, incorrectas });
      });

      state.questions = questions;
    }

    function populateSheetSelect(wb) {
      dom.sheetSelect.innerHTML = "";
      wb.SheetNames.forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        dom.sheetSelect.appendChild(opt);
      });
      dom.sheetSelect.disabled = wb.SheetNames.length === 0;
    }

    async function loadFile(file) {
      state.file = file;
      state.fileName = file?.name || null;
      state.workbook = null;
      state.sheetName = null;
      state.rawRows = [];
      state.questions = [];
      state.issues = [];

      dom.fileMeta.classList.toggle("hidden", !file);
      dom.fileName.textContent = file ? file.name : "";
      dom.dzIcon.className = "fa-solid fa-circle-notch fa-spin text-2xl text-[#39A900]";
      setStateBadge(false, "Procesando…");

      setLoading(true, "Leyendo Excel…");

      try {
        const buf = await file.arrayBuffer();
        dom.progressBar.style.width = "80%";
        dom.progressTxt.textContent = "Analizando hojas…";

        const wb = XLSX.read(buf, { type: "array" });
        state.workbook = wb;
        populateSheetSelect(wb);

        state.sheetName = wb.SheetNames[0] || null;
        dom.sheetSelect.value = state.sheetName || "";

        dom.progressBar.style.width = "95%";
        dom.progressTxt.textContent = "Construyendo preguntas…";

        if (!state.sheetName) throw new Error("No se encontraron hojas en el archivo.");

        const ws = wb.Sheets[state.sheetName];
        parseSheetToQuestions(ws);

        // Ajuste count al máximo
        const maxCount = Math.max(1, state.questions.length || 1);
        state.config.count = clampInt(state.config.count, 1, maxCount, Math.min(10, maxCount));

        setStateBadge(state.questions.length > 0, state.questions.length > 0 ? "Banco cargado" : "Sin preguntas válidas");
        dom.dotState.classList.toggle("bg-amber-500", state.questions.length === 0);

        dom.dzIcon.className = state.questions.length > 0
          ? "fa-solid fa-check text-2xl text-[#39A900]"
          : "fa-solid fa-triangle-exclamation text-2xl text-amber-600";

      } catch (err) {
        console.error(err);
        alert("Error al procesar el archivo Excel. Verifica el formato y reintenta.");
        clearFile();
        return;
      } finally {
        setLoading(false);
        renderStats();
        renderPreview();
      }
    }

    function reloadSelectedSheet() {
      if (!state.workbook || !state.sheetName) return;
      const ws = state.workbook.Sheets[state.sheetName];
      parseSheetToQuestions(ws);
      const maxCount = Math.max(1, state.questions.length || 1);
      state.config.count = clampInt(state.config.count, 1, maxCount, Math.min(10, maxCount));
      renderStats();
      renderPreview();
      setStateBadge(state.questions.length > 0, state.questions.length > 0 ? "Banco cargado" : "Sin preguntas válidas");
    }

    function clearFile() {
      state.file = null;
      state.fileName = null;
      state.workbook = null;
      state.sheetName = null;
      state.rawRows = [];
      state.questions = [];
      state.issues = [];
      dom.fileInput.value = "";
      dom.fileMeta.classList.add("hidden");
      dom.sheetSelect.innerHTML = '<option value="">—</option>';
      dom.sheetSelect.disabled = true;
      dom.dzIcon.className = "fa-solid fa-cloud-arrow-up text-2xl text-slate-400";
      setStateBadge(false, "Sin archivo");
      renderStats();
      renderPreview();
    }

    /** ============================
     *  Modal de issues
     *  ============================ */
    function openIssues() {
      dom.issuesTbody.innerHTML = state.issues.map(x => {
        const badge = x.type === "ERROR"
          ? '<span class="inline-flex items-center px-2 py-1 rounded-lg text-[11px] font-extrabold bg-rose-50 text-rose-700 border border-rose-200">ERROR</span>'
          : x.type === "WARN"
            ? '<span class="inline-flex items-center px-2 py-1 rounded-lg text-[11px] font-extrabold bg-amber-50 text-amber-700 border border-amber-200">WARN</span>'
            : '<span class="inline-flex items-center px-2 py-1 rounded-lg text-[11px] font-extrabold bg-slate-50 text-slate-700 border border-slate-200">INFO</span>';
        return `
          <tr class="border-b border-slate-100">
            <td class="p-3 font-extrabold mono">${x.rowIndex}</td>
            <td class="p-3">${escapeHtml(x.detail)}</td>
            <td class="p-3">${badge}</td>
          </tr>
        `;
      }).join("") || `
        <tr><td colspan="3" class="p-4 text-slate-500">Sin novedades.</td></tr>
      `;
      dom.issuesDialog.showModal();
    }

    /** ============================
     *  Generación del HTML del examen (offline)
     *  ============================ */
    
    function buildQuizData() {
      readConfigFromDom();

      // Exportar TODO el banco válido (para que cada intento pueda seleccionar aleatoriamente)
      const questions = state.questions.map(q => ({
        pregunta: q.pregunta,
        correctas: q.correctas.slice(),
        incorrectas: q.incorrectas.slice()
      }));

      return {
        QUESTIONS_DATA: questions,
        CONFIG_DATA: {
          title: state.config.title,
          instructor: state.config.instructor,
          count: clampInt(state.config.count, 1, Math.max(1, questions.length), Math.min(10, Math.max(1, questions.length))),
          optionsCount: clampInt(state.config.optionsCount, 2, 10, 4),
          hasTimer: !!state.config.hasTimer,
          timeLimit: clampInt(state.config.timeLimit, 1, 999, 30),
          sequentialMode: !!state.config.sequentialMode,
          shuffleQuestions: !!state.config.shuffleQuestions,
          shuffleOptions: !!state.config.shuffleOptions
        }
      };
    }



    function generateQuizHtml(quizPack) {
      const SCR = "<scr" + "ipt";
      const ESCR = "</scr" + "ipt>";

      const cfg = quizPack.CONFIG_DATA || {};
      const title = escapeHtml(cfg.title || "EVALUACIÓN DE APRENDIZAJE");
      const instructor = escapeHtml(cfg.instructor || "");
      const count = clampInt(cfg.count, 1, 999999, 10);
      const optionsCount = clampInt(cfg.optionsCount, 2, 10, 4);
      const hasTimer = !!cfg.hasTimer;
      const timeLimit = clampInt(cfg.timeLimit, 1, 999, 30);
      const sequentialMode = !!cfg.sequentialMode;
      const shuffleQuestions = !!cfg.shuffleQuestions;
      const shuffleOptions = !!cfg.shuffleOptions;

      const questionsJson = JSON.stringify(quizPack.QUESTIONS_DATA || []).replaceAll("</", "<\\/");
      const configJson = JSON.stringify({
        title: cfg.title || "EVALUACIÓN DE APRENDIZAJE",
        instructor: cfg.instructor || "",
        count, optionsCount, hasTimer, timeLimit, sequentialMode, shuffleQuestions, shuffleOptions
      }).replaceAll("</", "<\\/");

      return `<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>${title}</title>

  ${SCR} src="https://cdn.tailwindcss.com">${ESCR}
  ${SCR} src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">${ESCR}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap');
    body { font-family: 'Montserrat', sans-serif; }
    .sena-bg { background-color: #39A900; }
    .sena-text { color: #39A900; }
    .option-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    .selected-option { border-color: #39A900 !important; background-color: #f0fdf4 !important; }

    /* Scrollbar */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #39A900; border-radius: 10px; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade { animation: fadeIn 0.4s ease-out forwards; }

    /* Cronómetro Circular */
    .timer-container { position: relative; width: 60px; height: 60px; background: white; border-radius: 50%; padding: 2px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .timer-svg { transform: rotate(-90deg); width: 56px; height: 56px; }
    .timer-bg { fill: none; stroke: #f1f5f9; stroke-width: 5; }
    .timer-progress { fill: none; stroke: #39A900; stroke-width: 5; stroke-linecap: round; transition: stroke-dashoffset 1s linear; }

    /* Paginación */
    .page-dot {
      width: 36px; height: 36px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 12px; font-weight: 900; font-size: 12px;
      cursor: pointer; transition: all 0.2s;
      border: 2px solid transparent;
    }
    .page-dot.active { background-color: #39A900; color: white; transform: scale(1.1); box-shadow: 0 4px 12px rgba(57,169,0,0.3); }
    .page-dot.answered { border-color: #39A900; color: #39A900; background-color: #f0fdf4; }
    .page-dot.pending { background-color: #f8fafc; color: #cbd5e1; border-color: #f1f5f9; }
  </style>
</head>

<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4">
  <div id="quiz-app" class="max-w-2xl w-full bg-white rounded-[2.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.1)] overflow-hidden border border-slate-100">

    <!-- PANTALLA DE INICIO -->
    <div id="screen-start" class="p-12 text-center animate-fade">
      <img src="https://www.sena.edu.co/Style%20Library/alayout/images/logoSena.png" alt="Logo SENA" class="w-24 h-24 mx-auto mb-8">
      <h1 class="text-4xl font-black text-slate-900 mb-2 tracking-tight uppercase">${title}</h1>
      <p class="text-slate-400 text-xs font-black tracking-[0.3em] uppercase mb-12">
        Instructor: <span class="text-slate-600">${instructor ? instructor.toUpperCase() : "POR ASIGNAR"}</span>
      </p>

      <div class="max-w-sm mx-auto mb-12 text-left">
        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 ml-1">Aprendiz</label>
        <input type="text" id="input-learner" placeholder="NOMBRE COMPLETO"
          class="w-full px-8 py-5 rounded-3xl border-2 border-slate-100 focus:border-[#39A900] focus:outline-none transition-all font-black text-xl shadow-sm uppercase tracking-tighter" />
      </div>

      <div class="grid grid-cols-2 gap-6 mb-12">
        <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100 text-center">
          <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Items</p>
          <p class="text-2xl font-black text-slate-800">${count}</p>
        </div>
        <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100 text-center">
          <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Duración</p>
          <p class="text-2xl font-black text-slate-800">${hasTimer ? `${timeLimit} Min` : "—"}</p>
        </div>
      </div>

      <button onclick="quizEngine.start()" class="sena-bg hover:bg-[#2d8500] text-white font-black py-6 px-12 rounded-[2rem] transition-all shadow-xl w-full text-xl uppercase tracking-widest active:scale-95">
        COMENZAR EXAMEN
      </button>
    </div>

    <!-- PANTALLA DE CUESTIONARIO -->
    <div id="screen-quiz" class="hidden">
      <div class="sena-bg px-8 py-6 text-white flex justify-between items-center relative">
        <div class="z-10">
          <span id="label-learner" class="text-[9px] font-black uppercase tracking-[0.2em] opacity-80 block mb-1"></span>
          <span id="label-progress" class="font-black text-lg uppercase tracking-tight"></span>
        </div>

        ${hasTimer ? `
        <div class="flex items-center gap-4 z-10 bg-white p-3 rounded-2xl shadow-lg">
          <div class="text-right">
            <span class="text-[8px] font-black uppercase text-slate-400 block leading-none mb-1">Tiempo</span>
            <span id="label-timer" class="font-black text-base tracking-widest leading-none text-slate-900">00:00</span>
          </div>
          <div class="timer-container">
            <svg class="timer-svg" viewBox="0 0 60 60">
              <circle class="timer-bg" cx="30" cy="30" r="26"></circle>
              <circle id="timer-ring" class="timer-progress" cx="30" cy="30" r="26"></circle>
            </svg>
          </div>
        </div>` : `
        <div class="flex items-center gap-3 z-10 bg-white px-4 py-3 rounded-2xl shadow-lg">
          <span class="text-[8px] font-black uppercase text-slate-400 tracking-[0.2em]">Sin temporizador</span>
        </div>`}
      </div>

      <div class="h-2 bg-slate-100 w-full overflow-hidden">
        <div id="bar-progress" class="h-full sena-bg transition-all duration-500" style="width: 0%"></div>
      </div>

      <div class="p-10">
        <div id="nav-pagination" class="flex flex-wrap gap-2 mb-8 justify-center border-b border-slate-50 pb-6 custom-scrollbar max-h-24 overflow-y-auto"></div>

        <div id="notice-multi" class="hidden mb-6 p-4 rounded-2xl bg-blue-50 border border-blue-100 text-[10px] font-black text-blue-700 uppercase flex items-center gap-3">
          <i class="fas fa-check-double text-lg"></i> Selección Múltiple
        </div>

        <h2 id="quiz-question" class="text-2xl font-black mb-8 leading-snug min-h-[4rem] text-slate-900"></h2>
        <div id="quiz-options" class="space-y-4"></div>

        <div class="mt-12 flex gap-4">
          <button id="btn-prev" onclick="quizEngine.prev()" class="px-8 py-5 border-2 border-slate-100 text-slate-400 font-black rounded-3xl transition-all hover:bg-slate-50 uppercase tracking-widest text-sm active:scale-95">
            <i class="fas fa-chevron-left mr-2"></i> Anterior
          </button>

          <button id="btn-main" onclick="quizEngine.handleMainAction()" class="flex-grow sena-bg hover:bg-[#2d8500] text-white font-black py-5 rounded-[1.5rem] transition-all shadow-xl text-xl uppercase tracking-widest active:scale-95">
            SIGUIENTE
          </button>
        </div>
      </div>
    </div>

    <!-- PANTALLA DE RESULTADOS -->
    <div id="screen-results" class="hidden p-12 animate-fade">
      <div class="text-center mb-10">
        <div class="w-20 h-20 sena-bg text-white rounded-[2rem] flex items-center justify-center mx-auto mb-8 shadow-xl">
          <i class="fas fa-poll text-4xl"></i>
        </div>
        <h2 class="text-3xl font-black text-slate-900 mb-2 uppercase tracking-tight">RESULTADOS</h2>
        <p id="res-learner" class="text-slate-400 font-black uppercase tracking-widest text-[11px]"></p>
        <p id="res-instructor" class="text-slate-400 font-black uppercase tracking-widest text-[11px] mt-2"></p>
      </div>

      <div class="bg-slate-50 rounded-[2.5rem] p-10 border border-slate-100 text-center mb-10 shadow-inner">
        <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-4">Calificación</p>
        <p id="res-score" class="text-8xl font-black text-slate-900 mb-6 tracking-tighter">0/0</p>
        <div id="res-status" class="inline-block px-12 py-4 rounded-full font-black text-sm uppercase tracking-widest shadow-lg"></div>
      </div>

      <div class="grid grid-cols-1 gap-4 mb-10">
        <button onclick="quizEngine.generatePDF()" class="w-full py-6 bg-slate-900 text-white rounded-[1.5rem] font-black text-base hover:bg-slate-800 transition-all flex items-center justify-center gap-4 shadow-xl active:scale-95">
          <i class="fas fa-file-pdf"></i> GENERAR PDF
        </button>
        <button onclick="location.reload()" class="py-4 border-2 border-slate-100 rounded-[1.5rem] font-black text-slate-400 text-xs hover:bg-slate-50 uppercase tracking-widest transition-all">
          NUEVO INTENTO
        </button>
      </div>

      <div class="space-y-4 max-h-[300px] overflow-y-auto pr-3 custom-scrollbar border-t border-slate-100 pt-8" id="res-list"></div>
    </div>

  </div>

  ${SCR}>
    // Datos inyectados por el generador
    const QUESTIONS_DATA = ${questionsJson};
    const CONFIG_DATA = ${configJson};

    const quizEngine = {
      currentIndex: 0,
      score: 0,
      learnerName: '',
      sessionPool: [],
      userAnswers: [],
      displayOptions: [],
      timerId: null,
      secondsLeft: (CONFIG_DATA.timeLimit || 30) * 60,
      totalSeconds: (CONFIG_DATA.timeLimit || 30) * 60,

      shuffle(array) {
        let current = array.length, random;
        while (current != 0) {
          random = Math.floor(Math.random() * current);
          current--;
          [array[current], array[random]] = [array[random], array[current]];
        }
        return array;
      },

      start() {
        const name = document.getElementById('input-learner').value.trim();
        if (!name) { alert('INGRESE SU NOMBRE'); return; }
        this.learnerName = name.toUpperCase();

        // Pool de preguntas (barajar o no)
        const basePool = CONFIG_DATA.shuffleQuestions ? this.shuffle([...QUESTIONS_DATA]) : [...QUESTIONS_DATA];
        this.sessionPool = basePool.slice(0, CONFIG_DATA.count);

        this.userAnswers = [];
        this.displayOptions = [];

        this.sessionPool.forEach(q => {
          this.userAnswers.push([]);

          const neededIncorrect = Math.max(0, CONFIG_DATA.optionsCount - q.correctas.length);
          const incorrectPool = CONFIG_DATA.shuffleOptions ? this.shuffle([...q.incorrectas]) : [...q.incorrectas];
          const pickedIncorrect = incorrectPool.slice(0, neededIncorrect);

          const combined = [...q.correctas, ...pickedIncorrect];
          const finalOptions = CONFIG_DATA.shuffleOptions ? this.shuffle(combined) : combined;

          this.displayOptions.push(finalOptions);
        });

        document.getElementById('screen-start').classList.add('hidden');
        document.getElementById('screen-quiz').classList.remove('hidden');
        document.getElementById('label-learner').innerText = this.learnerName;

        if (CONFIG_DATA.hasTimer) this.initTimer();
        this.render();
      },

      initTimer() {
        const label = document.getElementById('label-timer');
        const ring = document.getElementById('timer-ring');
        const circumference = 26 * 2 * Math.PI;

        if (ring) {
          ring.style.strokeDasharray = circumference;
          ring.style.strokeDashoffset = 0;
        }

        this.secondsLeft = (CONFIG_DATA.timeLimit || 30) * 60;
        this.totalSeconds = (CONFIG_DATA.timeLimit || 30) * 60;

        const tick = () => {
          this.secondsLeft--;
          const m = Math.floor(this.secondsLeft / 60);
          const s = this.secondsLeft % 60;
          if (label) label.innerText = m.toString().padStart(2,'0') + ':' + s.toString().padStart(2,'0');

          if (ring) {
            const offset = circumference - (this.secondsLeft / this.totalSeconds) * circumference;
            ring.style.strokeDashoffset = offset;
          }

          if (this.secondsLeft <= 0) {
            clearInterval(this.timerId);
            alert('¡TIEMPO AGOTADO!');
            this.finish();
          }
        };

        // Pintar inicial
        if (label) label.innerText = Math.floor(this.secondsLeft/60).toString().padStart(2,'0') + ':00';

        this.timerId = setInterval(tick, 1000);
      },

      render() {
        const q = this.sessionPool[this.currentIndex];
        const opts = this.displayOptions[this.currentIndex];
        const isMulti = q.correctas.length > 1;

        document.getElementById('notice-multi').style.display = isMulti ? 'flex' : 'none';
        document.getElementById('quiz-question').innerText = q.pregunta;
        document.getElementById('label-progress').innerText = 'ITEM ' + (this.currentIndex + 1) + ' / ' + CONFIG_DATA.count;
        document.getElementById('bar-progress').style.width = ((this.currentIndex + 1) / CONFIG_DATA.count * 100) + '%';

        const optionsContainer = document.getElementById('quiz-options');
        optionsContainer.innerHTML = '';

        opts.forEach(opt => {
          const btn = document.createElement('button');
          const isSelected = this.userAnswers[this.currentIndex].includes(opt);
          btn.className = 'option-btn w-full text-left p-6 rounded-[1.5rem] border-2 border-slate-100 font-black flex items-center gap-5 bg-white shadow-sm group animate-fade';
          if (isSelected) btn.classList.add('selected-option');

          const indicatorClass = isSelected ? 'sena-bg border-[#39A900] text-white' : 'text-transparent border-slate-200';
          btn.innerHTML = '<div class="indicator w-7 h-7 rounded-xl border-2 flex items-center justify-center text-[11px] ' + indicatorClass + ' transition-colors"><i class="fas fa-check"></i></div> <span class="text-slate-700">' + opt + '</span>';
          btn.onclick = () => this.toggle(btn, opt, isMulti);
          optionsContainer.appendChild(btn);
        });

        const isLast = this.currentIndex === CONFIG_DATA.count - 1;
        document.getElementById('btn-main').innerText = isLast ? 'FINALIZAR' : 'SIGUIENTE';

        const prevBtn = document.getElementById('btn-prev');
        const nav = document.getElementById('nav-pagination');

        if (CONFIG_DATA.sequentialMode) {
          if (prevBtn) prevBtn.style.display = 'none';
          if (nav) nav.style.display = 'none';
        } else {
          if (nav) nav.style.display = 'flex';
          this.renderPagination();
          if (prevBtn) prevBtn.style.display = this.currentIndex > 0 ? 'flex' : 'none';
        }
      },

      renderPagination() {
        const nav = document.getElementById('nav-pagination');
        if (!nav) return;
        nav.innerHTML = '';
        this.sessionPool.forEach((_, i) => {
          const dot = document.createElement('div');
          const hasAnswer = this.userAnswers[i].length > 0;
          const isCurrent = this.currentIndex === i;

          dot.className = 'page-dot';
          if (isCurrent) dot.classList.add('active');
          else if (hasAnswer) dot.classList.add('answered');
          else dot.classList.add('pending');

          dot.innerText = i + 1;
          dot.onclick = () => { this.currentIndex = i; this.render(); };
          nav.appendChild(dot);
        });
      },

      toggle(el, val, multi) {
        let current = this.userAnswers[this.currentIndex];

        if (!multi) {
          document.querySelectorAll('.option-btn').forEach(b => {
            b.classList.remove('selected-option');
            const ind = b.querySelector('.indicator');
            if (ind) ind.className = 'indicator w-7 h-7 rounded-xl border-2 border-slate-200 flex items-center justify-center text-[11px] text-transparent transition-colors';
          });
          this.userAnswers[this.currentIndex] = [val];
        } else {
          const idx = current.indexOf(val);
          if (idx > -1) current.splice(idx, 1);
          else current.push(val);
        }

        const isNow = this.userAnswers[this.currentIndex].includes(val);
        const ind = el.querySelector('.indicator');

        if (isNow) {
          el.classList.add('selected-option');
          if (ind) ind.className = 'indicator w-7 h-7 rounded-xl border-2 sena-bg border-[#39A900] text-white flex items-center justify-center text-[11px] transition-colors';
        } else {
          el.classList.remove('selected-option');
          if (ind) ind.className = 'indicator w-7 h-7 rounded-xl border-2 border-slate-200 flex items-center justify-center text-[11px] text-transparent transition-colors';
        }

        if (!CONFIG_DATA.sequentialMode) this.renderPagination();
      },

      prev() {
        if (this.currentIndex > 0) {
          this.currentIndex--;
          this.render();
        }
      },

      handleMainAction() {
        if (this.userAnswers[this.currentIndex].length === 0) {
          alert('POR FAVOR SELECCIONE UNA RESPUESTA');
          return;
        }

        if (this.currentIndex < CONFIG_DATA.count - 1) {
          this.currentIndex++;
          this.render();
        } else {
          this.finish();
        }
      },

      finish() {
        clearInterval(this.timerId);

        this.score = 0;
        const results = [];

        this.sessionPool.forEach((q, i) => {
          const sel = this.userAnswers[i];
          const correct = sel.length === q.correctas.length && sel.every(v => q.correctas.includes(v));
          if (correct) this.score++;

          results.push({
            q: q.pregunta,
            sel: sel.length > 0 ? sel.join(', ') : 'SIN RESPUESTA',
            ok: q.correctas.join(', '),
            correct
          });
        });

        document.getElementById('screen-quiz').classList.add('hidden');
        document.getElementById('screen-results').classList.remove('hidden');

        document.getElementById('res-learner').innerText = 'APRENDIZ: ' + this.learnerName;
        document.getElementById('res-instructor').innerText = 'INSTRUCTOR: ' + (CONFIG_DATA.instructor || 'PLATAFORMA').toUpperCase();
        document.getElementById('res-score').innerText = this.score + ' / ' + CONFIG_DATA.count;

        const ratio = (this.score / CONFIG_DATA.count) * 100;
        const badge = document.getElementById('res-status');

        if (ratio >= 70) {
          badge.innerText = 'APROBADO';
          badge.className = 'inline-block px-12 py-4 rounded-full font-black text-sm uppercase tracking-widest bg-green-100 text-green-700 shadow-sm';
        } else {
          badge.innerText = 'NO APROBADO';
          badge.className = 'inline-block px-12 py-4 rounded-full font-black text-sm uppercase tracking-widest bg-red-100 text-red-700 shadow-sm';
        }

        const list = document.getElementById('res-list');
        list.innerHTML = '';
        results.forEach((item, i) => {
          const div = document.createElement('div');
          div.className = 'p-6 rounded-[2rem] border-2 ' + (item.correct ? 'border-green-100 bg-green-50/40' : 'border-red-100 bg-red-50/40');
          div.innerHTML =
            '<p class="text-[12px] font-black mb-3 text-slate-800 uppercase tracking-tight">' + (i+1) + '. ' + item.q + '</p>' +
            '<div class="flex flex-col gap-2 text-[10px] font-black uppercase tracking-widest">' +
              '<span class="' + (item.correct ? 'text-green-600' : 'text-red-500') + '">SELECCIÓN: ' + item.sel + '</span>' +
              '<span class="text-slate-400">CORRECTA: ' + item.ok + '</span>' +
            '</div>';
          list.appendChild(div);
        });
      },

      generatePDF() {
        // PDF simple, con jsPDF (si está disponible)
        if (!window.jspdf || !window.jspdf.jsPDF) {
          alert('No se pudo cargar jsPDF. Verifique conexión a internet.');
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const ratio = Math.round((this.score / CONFIG_DATA.count) * 100);
        const date = new Date().toLocaleString().toUpperCase();

        doc.setFillColor(57, 169, 0);
        doc.rect(0, 0, 210, 45, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.setFont("helvetica", "bold");
        doc.text("RESULTADOS DE EVALUACIÓN", 105, 28, { align: "center" });

        doc.setTextColor(50, 50, 50);
        doc.setFontSize(13);
        doc.text('PRUEBA: ' + (CONFIG_DATA.title || '').toUpperCase(), 20, 60);
        doc.text('APRENDIZ: ' + this.learnerName, 20, 70);
        doc.text('FECHA: ' + date, 20, 80);

        doc.setDrawColor(230, 230, 230);
        doc.line(20, 90, 190, 90);

        doc.setFontSize(18);
        doc.text("CALIFICACIÓN", 105, 115, { align: "center" });
        doc.setFontSize(60);
        doc.text(this.score + ' / ' + CONFIG_DATA.count, 105, 145, { align: "center" });

        doc.setFontSize(18);
        const status = ratio >= 70 ? "APROBADO" : "NO APROBADO";
        doc.setTextColor(ratio >= 70 ? 57 : 200, ratio >= 70 ? 169 : 0, 0);
        doc.text(status, 105, 165, { align: "center" });

        const safeName = this.learnerName.replace(/\s+/g, '_');
        doc.save('Resultado_' + safeName + '.pdf');
      }
    };
  ${ESCR}
</body>
</html>`;
    }



    function downloadHtml(html, filename) {
      const blob = new Blob([html], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function previewHtml(html) {
      const blob = new Blob([html], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank", "noopener,noreferrer");
      setTimeout(() => URL.revokeObjectURL(url), 60_000);
    }

    function doGenerate(mode) {
      if (!state.questions.length) return;

      const quizData = buildQuizData();
      const html = generateQuizHtml(quizData);

      const file = "QuizSENA_" + slugify(state.config.title) + ".html";

      if (mode === "preview") previewHtml(html);
      else downloadHtml(html, file);
    }

    /** ============================
     *  Eventos UI
     *  ============================ */
    function bind() {
      // Config bindings
      [
        dom.cfgTitle, dom.cfgInstructor, dom.cfgCount, dom.cfgOptions,
        dom.cfgTimer, dom.cfgTimeLimit, dom.cfgSequential, dom.cfgShuffleQ, dom.cfgShuffleO
      ].forEach((el) => {
        el.addEventListener("input", () => {
          if (el === dom.cfgTimer) {
            dom.timerRow.classList.toggle("hidden", !dom.cfgTimer.checked);
            dom.timerRow.classList.toggle("flex", !!dom.cfgTimer.checked);
          }
          readConfigFromDom();
          renderStats();
        });
        el.addEventListener("change", () => {
          if (el === dom.cfgTimer) {
            dom.timerRow.classList.toggle("hidden", !dom.cfgTimer.checked);
            dom.timerRow.classList.toggle("flex", !!dom.cfgTimer.checked);
          }
          readConfigFromDom();
          renderStats();
        });
      });

      // File select
      dom.fileInput.addEventListener("change", (e) => {
        const f = e.target.files?.[0];
        if (f) loadFile(f);
      });

      // Dropzone
      dom.dropzone.addEventListener("click", () => dom.fileInput.click());
      dom.dropzone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dom.dropzone.classList.add("ring-2", "ring-[#39A900]/30", "border-[#39A900]");
      });
      dom.dropzone.addEventListener("dragleave", () => {
        dom.dropzone.classList.remove("ring-2", "ring-[#39A900]/30", "border-[#39A900]");
      });
      dom.dropzone.addEventListener("drop", (e) => {
        e.preventDefault();
        dom.dropzone.classList.remove("ring-2", "ring-[#39A900]/30", "border-[#39A900]");
        const f = e.dataTransfer.files?.[0];
        if (f) loadFile(f);
      });

      // Sheet change
      dom.sheetSelect.addEventListener("change", () => {
        state.sheetName = dom.sheetSelect.value || null;
        reloadSelectedSheet();
      });

      dom.btnShowIssues.addEventListener("click", openIssues);
      dom.btnCloseIssues.addEventListener("click", () => dom.issuesDialog.close());
      dom.btnClearFile.addEventListener("click", clearFile);

      dom.btnPreview.addEventListener("click", () => doGenerate("preview"));
      dom.btnGenerate.addEventListener("click", () => doGenerate("download"));

      dom.btnReset.addEventListener("click", () => {
        localStorage.removeItem(STORAGE_KEY);
        loadConfig();
        syncConfigToDom();
        renderPreview();
      });

      // Enable reset (desktop)
      dom.btnReset.classList.remove("hidden");
    }

    /** ============================
     *  Init
     *  ============================ */
    loadConfig();
    syncConfigToDom();
    renderStats();
    renderPreview();
    bind();
  </script>
</body>
</html>
